#include QMK_KEYBOARD_H
#include "rhruiz.h"
#include "rhruiz_kc_keys.h"

#define KC__GFN1 MO(_GAMEFN1)

#ifdef OLED_DRIVER_ENABLE
static uint32_t      oled_timer = 0;
extern volatile bool isLeftHand;
#endif

// clang-format off
const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
  [_BL] = LAYOUT_kc(
// .-----+-----+-----+-----+-----+-----.                .-----+-----+-----+-----+-----+-----.
     GRV ,  1  ,  2  ,  3  ,  4  ,  5  ,                   6  ,  7  ,  8  ,  9  ,  0  , ESC ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
     TAB ,  Q  ,  W  ,  E  ,  R  ,  T  ,                   Y  ,  U  ,  I  ,  O  ,  P  , MINS,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
     CESC,  A  ,  S  ,  D  ,  F  ,  G  ,                   H  ,  J  ,  K  ,  L  , SCLN, QUOT,
// |-----+-----+-----+-----+-----+-----|-----|    |-----|-----+-----+-----+-----+-----+-----|
     LSFT,  Z  ,  X  ,  C  ,  V  ,  B  , _TAP,      EPIP,  N  ,  M  , COMM, DOT , SLSH, RSFT,
// `-----+-----+-----+-----+-----+----/-----/      \-----\----+-----+-----+-----+-----+-----'
                    LALT, LGUI, _FN1 , SPC ,          ENT , _FN2 , BSPC, RGUI
//                `-----+-----+----'/-----/          \-----\'----+-----+-----'
  ),

  [_VIM_EMACS] = LAYOUT_kc(
// .-----+-----+-----+-----+-----+-----.                .-----+-----+-----+-----+-----+-----.
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|-----|    |-----|-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,     ,          ,     ,     ,     ,     ,     ,     ,
// `-----+-----+-----+-----+-----+----/-----/      \-----\----+-----+-----+-----+-----+-----'
                        ,     ,      ,     ,              ,      ,     ,
//                `-----+-----+----'/-----/          \-----\'----+-----+-----'
  ),

  [_MOUSE] = LAYOUT_kc(
// .-----+-----+-----+-----+-----+-----.                .-----+-----+-----+-----+-----+-----.
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|-----|    |-----|-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,     ,          ,     ,     ,     ,     ,     ,     ,
// `-----+-----+-----+-----+-----+----/-----/      \-----\----+-----+-----+-----+-----+-----'
                        ,     ,      ,     ,              ,      ,     ,
//                `-----+-----+----'/-----/          \-----\'----+-----+-----'
  ),

  [_KEY_OVERRIDE] = LAYOUT_kc( \
// .-----+-----+-----+-----+-----+-----.                .-----+-----+-----+-----+-----+-----.
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     , DEL ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     , COLN, DQUO,
// |-----+-----+-----+-----+-----+-----|-----|    |-----|-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,     ,          ,     ,     ,     ,     , QUES,     ,
// `-----+-----+-----+-----+-----+----/-----/      \-----\----+-----+-----+-----+-----+-----'
                        ,     ,      ,     ,              ,      ,     ,
//                `-----+-----+----'/-----/          \-----\'----+-----+-----'
  ),
  [_FN1] = LAYOUT_kc(
// .-----+-----+-----+-----+-----+-----.                .-----+-----+-----+-----+-----+-----.
     TILD, EXLM,  AT , HASH, DLR , PERC,                  CIRC, AMPR, ASTR, LPRN, RPRN,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
     GRV ,  1  ,  2  ,  3  ,  4  ,  5  ,                   6  ,  7  ,  8  ,  9  ,  0  ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         , BSLS, LBRC, RBRC, MINS, PLUS,                      ,     , LPRN, RPRN,     ,     ,
// |-----+-----+-----+-----+-----+-----|-----|    |-----|-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     , _TAN,          ,     ,     ,     ,     ,     ,     ,
// `-----+-----+-----+-----+-----+----/-----/      \-----\----+-----+-----+-----+-----+-----'
                               ,     ,     ,              ,     ,      ,     ,
//                `-----+-----+----'/-----/          \-----\'----+-----+-----'
  ),

 [_FN2] = LAYOUT_kc(
// .-----+-----+-----+-----+-----+-----.                .-----+-----+-----+-----+-----+-----.
     F12 , F1 ,  F2 ,  F3 ,  F4 ,  F5 ,                   F6  ,  F7 ,  F8 ,  F9 , F10 , F11 ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
     TILD, EXLM,  AT , HASH, DLR,  PERC,                  CIRC, AMPR, ASTR, LPRN, RPRN,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         , PIPE, LCBR, RCBR, UNDS, EQL ,                  LEFT, DOWN,  UP , RGHT,     ,     ,
// |-----+-----+-----+-----+-----+-----|-----|    |-----|-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     , _BCK,          ,     ,     ,  LT ,  GT ,     ,     ,
// `-----+-----+-----+-----+-----+----/-----/      \-----\----+-----+-----+-----+-----+-----'
                               ,     ,     ,              ,     ,      ,     ,
//                `-----+-----+----'/-----/          \-----\'----+-----+-----'
 ),

  [_CFG] = LAYOUT_kc(
// .-----+-----+-----+-----+-----+-----.                .-----+-----+-----+-----+-----+-----.
     ESC , SLCK, PAUS, MISS, RVAD, RVAI,                      ,     ,     ,     ,     , _RST,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
     MAKE, RTOG, RMOD, RHUI, RSAI, RVAI,                  _WL , _STP, _SBT, _WR ,     ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         , _VUP, _VDN, MUTE, EJCT,     ,                  HOME, PGDN, PGUP, END ,     ,     ,
// |-----+-----+-----+-----+-----+-----|-----|    |-----|-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     , _TGM,      _TGN,     ,     ,     ,     ,     ,     ,
// `-----+-----+-----+-----+-----+----/-----/      \-----\----+-----+-----+-----+-----+-----'
                        ,     ,      ,     ,              ,      ,     ,
//                `-----+-----+----'/-----/          \-----\'----+-----+-----'
  ),

  [_NUM] = LAYOUT_kc(
// .-----+-----+-----+-----+-----+-----.                .-----+-----+-----+-----+-----+-----.
         ,  1  ,  2  ,  3  ,  4  ,  5  ,                   6  ,  7  ,  8  ,  9  ,  0  ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         , BTN1, MS_U, BTN2, WH_D,     ,                      ,  4  ,  5  ,  6  , PLUS,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         , MS_L, MS_D, MS_R, WH_U,     ,                  ASTR,  1  ,  2  ,  3  , MINS,     ,
// |-----+-----+-----+-----+-----+-----|-----|    |-----|-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,     ,      _TGN, EQL ,  0  ,     ,     ,     ,     ,
// `-----+-----+-----+-----+-----+----/-----/      \-----\----+-----+-----+-----+-----+-----'
                        ,     ,      ,     ,              ,      ,     ,
//                `-----+-----+----'/-----/          \-----\'----+-----+-----'
  ),

  [_GAME] = LAYOUT_kc(
// .-----+-----+-----+-----+-----+-----.                .-----+-----+-----+-----+-----+-----.
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|-----|    |-----|-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     , BSPC,          ,     ,     ,     ,     ,     ,     ,
// `-----+-----+-----+-----+-----+----/-----/      \-----\----+-----+-----+-----+-----+-----'
                        ,     , _GFN1,     ,              ,      ,     ,
//                `-----+-----+----'/-----/          \-----\'----+-----+-----'
  ),

  [_GAMEFN1] = LAYOUT_kc(
// .-----+-----+-----+-----+-----+-----.                .-----+-----+-----+-----+-----+-----.
         ,  6  ,  7  ,  8  ,  9  ,  0  ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|-----|    |-----|-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,     ,          ,     ,     ,     ,     ,     ,     ,
// `-----+-----+-----+-----+-----+----/-----/      \-----\----+-----+-----+-----+-----+-----'
                        ,     ,      ,     ,              ,      ,     ,
//                `-----+-----+----'/-----/          \-----\'----+-----+-----'
  ),

/* template
// .-----+-----+-----+-----+-----+-----.                .-----+-----+-----+-----+-----+-----.
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|                |-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,                      ,     ,     ,     ,     ,     ,
// |-----+-----+-----+-----+-----+-----|-----|    |-----|-----+-----+-----+-----+-----+-----|
         ,     ,     ,     ,     ,     ,     ,          ,     ,     ,     ,     ,     ,     ,
// `-----+-----+-----+-----+-----+----/-----/      \-----\----+-----+-----+-----+-----+-----'
                        ,     ,      ,     ,              ,      ,     ,
//                `-----+-----+----'/-----/          \-----\'----+-----+-----'
*/
};
// clang-format on

#ifdef OLED_DRIVER_ENABLE

oled_rotation_t oled_init_user(oled_rotation_t rotation) { return rotation; }

// clang-format off
static const char lc[][4][3] = {
    [_BL]      = {{0x20, 0x20, 0}, {0x20, 0x20, 0}, {0x20, 0x20, 0}, {0x20, 0x20, 0}},
    [_FN1]     = {{0x20, 0x20, 0}, {0xb2, 0xb3, 0}, {0x92, 0x93, 0}, {0x20, 0x20, 0}},
    [_FN2]     = {{0x20, 0x20, 0}, {0x92, 0x93, 0}, {0xb2, 0xb3, 0}, {0x20, 0x20, 0}},
    [_CFG]     = {{0x82, 0x83, 0}, {0xa2, 0xa3, 0}, {0xc2, 0xc3, 0}, {0x82, 0x83, 0}},
    [_NUM]     = {{0xae, 0xaf, 0}, {0xce, 0xcf, 0}, {0x20, 0x20, 0}, {0xd2, 0xd3, 0}},
    [_GAME]    = {{0x20, 0x20, 0}, {0xb0, 0xb1, 0}, {0xd0, 0xd1, 0}, {0x20, 0x20, 0}},
    [_GAMEFN1] = {{0x20, 0x20, 0}, {0xb0, 0xb1, 0}, {0xd0, 0xd1, 0}, {0x11, 0x11, 0}},
};
// clang-format on

void rhruiz_render_oled(void) {
    layer_state_t layer = biton32(layer_state);

    switch (layer) {
        case _FN1:
        case _FN2:
            for (uint8_t i = 0; i < 4; i++) {
                oled_write("          ", false);

                for (uint8_t j = 0; j < 3; j++) {
                    oled_write(lc[layer][i], false);
                }

                oled_write("\n", false);
            }

            break;

        case _CFG:
            for (uint8_t i = 0; i < 4; i++) {
                for (uint8_t j = 0; j < 10; j++) {
                    oled_write(lc[layer][i], false);
                }

                oled_write("\n", false);
            }
            break;

        case _GAME:
        case _GAMEFN1:
        default:
            for (uint8_t i = 0; i < 4; i++) {
                oled_write("           ", false);
                oled_write_ln(lc[layer][i], false);
            }

            break;
    }
}

void rhruiz_render_logo_and_layer(void) {
    const char logo_line_1[] = {0x20, 0x94, 0x95, 0x96, 0x97, 0x98, 0x20, 0x20, 0x20, 0x20, 0x20, 0x88, 0x20, 0x20, 0x20, 0x20, 0x20, 0x16, 0x20, 0x20, 0};
    const char logo_line_2[] = {0x20, 0xb4, 0xb5, 0xb6, 0xb7, 0xb8, 0x20, 0x20, 0x20, 0xa6, 0xa7, 0xa8, 0xa9, 0xaa, 0xab, 0xac, 0xad, 0xc9, 0xae, 0xaf, 0};
    const char logo_line_3[] = {0x20, 0xd4, 0xd5, 0xd6, 0xd7, 0xd8, 0x20, 0x20, 0x20, 0xc6, 0xc7, 0xc8, 0xc9, 0xca, 0xcb, 0xcc, 0xcd, 0xc9, 0xce, 0xcf, 0};

    oled_write_ln(logo_line_1, false);
    oled_write_ln(logo_line_2, false);
    oled_write_ln(logo_line_3, false);
}

void oled_task_user(void) {
    if (is_keyboard_master()) {
        if (timer_elapsed32(oled_timer) > OLED_TIMEOUT) {
            oled_off();
            return;
        } else {
            oled_on();
        }

        rhruiz_render_oled();
    } else {
        rhruiz_render_logo_and_layer();
        oled_scroll_right();
    }
}

void suspend_power_down_user(void) { oled_off(); }

void suspend_wakeup_init_user(void) { oled_on(); }

#endif

bool rhruiz_process_record(uint16_t keycode, keyrecord_t *record) {
#ifdef OLED_DRIVER_ENABLE
    oled_timer = timer_read32();
#endif
    return true;
}
